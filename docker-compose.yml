version: '3.8'
services:
  cdn_service:
    image: ghcr.io/leonlav77/cdn_service:latest
    ports:
      - "8080:8080"
    environment:
      - SERVER_PORT=8080
      - API_BASE_URL=http://api_service:8000
      - AUTH_SERVICE_URL=http://auth_service:8001
      - DIRECTUS_API_URL=https://directus.leon-home-lab.ddns.net
      - WEBSOCKET_URL=ws://websocket_service:8002/ws
      - LOGIN_URL=/login
      - STATIC_FILES_PATH=static
    depends_on:
      - api_service
      - auth_service
      - websocket_service
  auth_service:
    image: ghcr.io/leonlav77/auth_service:latest
    environment:
      - SERVER_PORT=8001
      - JWT_SECRET=kaodajemorskavila

      - DB_HOST=auth_db
      - DB_PORT=5432
      - DB_USER=auth_user
      - DB_PASSWORD=auth_password
      - DB_NAME=ticketing
    depends_on:
      - auth_db
  auth_db:
    image: ghcr.io/leonlav77/postgres_service:latest
    environment:
      - POSTGRES_USER=auth_user
      - POSTGRES_PASSWORD=auth_password
      - POSTGRES_DB=ticketing
    volumes:
      - auth_db_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
  api_service:
    image: ghcr.io/leonlav77/data_aggregator_service:latest
    environment:
      - SERVER_PORT=8000
      - JWT_SECRET=kaodajemorskavila
      - DB_HOST=auth_db
      - DB_PORT=5432
      - DB_USER=auth_user
      - DB_PASSWORD=auth_password
      - DB_NAME=ticketing
      - DB_SSLMODE=disable
      - DIRECTUS_API_URL=https://directus.leon-home-lab.ddns.net
      - DIRECTUS_TOKEN=fswtQ0QA1dZFSI9eMOPB6_SfC2AwpBoB
    depends_on:
      - auth_db
  order_service:
    image: ghcr.io/leonlav77/order_service:latest
    environment:
      - DB_HOST=auth_db
      - DB_PORT=5432
      - DB_USER=auth_user
      - DB_PASSWORD=auth_password
      - DB_NAME=ticketing
      - DB_SSLMODE=disable
      - RABBITMQ_URL=amqp://admin:kaodajemorskavila@rabbitmq_service:5672/
      - QUEUE_ORDER_CREATED=order.created
      - QUEUE_ORDER_PAYMENT_SUCCESS=order.payment-success
    depends_on:
      - auth_db
      - rabbitmq_service
  payment_processor_service:
    image: ghcr.io/leonlav77/payment_processor_service:latest
    environment:
      - SERVER_PORT=8003
  ticket_purchase_service:
    image: ghcr.io/leonlav77/ticket_purchase_service:latest
    environment:
      - SERVER_PORT=8004
      - ETCD_ENDPOINT_1=etcd_service_1:2379
      - ETCD_ENDPOINT_2=etcd_service_2:2379
      - ETCD_ENDPOINT_3=etcd_service_3:2379
      - ETCD_DIAL_TIMEOUT=5s
      - REDIS_ADDR=tickets_redis_service:6379
      - RABBITMQ_URL=amqp://admin:kaodajemorskavila@rabbitmq_service:5672/
      - PAYMENT_PROCESSOR_URL=http://payment_processor_service:8003
      - FRONTEND_URL=http://cdn_service:8080
      - JWT_SECRET=kaodajemorskavila
      - LOGIN_URL=/login
      - REDIS_CACHE_TTL=10s
      - RESERVATION_TIMEOUT=15m
      - MAX_RETRIES=10
      - RETRY_DELAY=10ms
    depends_on:
      - etcd_service_1
      - etcd_service_2
      - etcd_service_3
      - tickets_redis_service
      - rabbitmq_service
      - payment_processor_service
  websocket_service:
    image: ghcr.io/leonlav77/websocket_service:latest
    environment:
      - SERVER_PORT=8002
      - REDIS_ADDR=websocket_redis_service:6379
      - WEBSOCKET_UPDATE_TIME_MS=2000
      - JWT_SECRET=kaodajemorskavila
      - LOGIN_URL=/login
    depends_on:
      - websocket_redis_service

  # RabbitMQ
  rabbitmq_service:
    image: rabbitmq:3-management
    environment:
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=kaodajemorskavila
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq

  # Redis instances
  tickets_redis_service:
    image: redis:7-alpine
    volumes:
      - tickets_redis_data:/data

  websocket_redis_service:
    image: redis:7-alpine
    volumes:
      - websocket_redis_data:/data

  # etcd cluster
  etcd_service_1:
    image: quay.io/coreos/etcd:v3.5.9
    environment:
      - ETCD_NAME=etcd1
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd_service_1:2380
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd_service_1:2379
      - ETCD_INITIAL_CLUSTER=etcd1=http://etcd_service_1:2380,etcd2=http://etcd_service_2:2380,etcd3=http://etcd_service_3:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
      - ETCD_INITIAL_CLUSTER_TOKEN=etcd-cluster
    volumes:
      - etcd1_data:/etcd-data

  etcd_service_2:
    image: quay.io/coreos/etcd:v3.5.9
    environment:
      - ETCD_NAME=etcd2
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd_service_2:2380
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd_service_2:2379
      - ETCD_INITIAL_CLUSTER=etcd1=http://etcd_service_1:2380,etcd2=http://etcd_service_2:2380,etcd3=http://etcd_service_3:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
      - ETCD_INITIAL_CLUSTER_TOKEN=etcd-cluster
    volumes:
      - etcd2_data:/etcd-data

  etcd_service_3:
    image: quay.io/coreos/etcd:v3.5.9
    environment:
      - ETCD_NAME=etcd3
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd_service_3:2380
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd_service_3:2379
      - ETCD_INITIAL_CLUSTER=etcd1=http://etcd_service_1:2380,etcd2=http://etcd_service_2:2380,etcd3=http://etcd_service_3:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
      - ETCD_INITIAL_CLUSTER_TOKEN=etcd-cluster
    volumes:
      - etcd3_data:/etcd-data

volumes:
  auth_db_data:
  rabbitmq_data:
  tickets_redis_data:
  websocket_redis_data:
  etcd1_data:
  etcd2_data:
  etcd3_data: